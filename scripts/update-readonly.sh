#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è read-only —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
set -e

echo "üîÑ Not Your Mama Bot - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (Read-Only —Ä–µ–∂–∏–º)"
echo "=================================================="

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è systemd —É—Å—Ç–∞–Ω–æ–≤–∫–∞
SYSTEMD_DIR="/opt/not-your-mama-bot"
CURRENT_DIR=$(pwd)

# –ï—Å–ª–∏ –º—ã –Ω–µ –≤ systemd –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –Ω–æ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –ø–µ—Ä–µ—Ö–æ–¥–∏–º —Ç—É–¥–∞
if [ "$CURRENT_DIR" != "$SYSTEMD_DIR" ] && [ -f "$SYSTEMD_DIR/bot.py" ]; then
    echo "üìç –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ systemd –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $SYSTEMD_DIR"
    cd "$SYSTEMD_DIR"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "bot.py" ]; then
    echo "‚ùå –§–∞–π–ª bot.py –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å
if [ ! -w . ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è"
    echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:"
    echo "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏"
    echo "‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)"
    echo "‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
    if [ -d ".git" ]; then
        echo ""
        echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏:"
        git log --oneline -5
        echo ""
        echo "üìç –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $(git rev-parse --short HEAD)"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–∞ –ª–∏ —Å–ª—É–∂–±–∞ systemd
    if command -v systemctl >/dev/null 2>&1; then
        if systemctl is-active --quiet not-your-mama-bot; then
            echo "‚úÖ –°–ª—É–∂–±–∞ not-your-mama-bot –∞–∫—Ç–∏–≤–Ω–∞"
            echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–±—ã..."
            if sudo systemctl restart not-your-mama-bot; then
                echo "‚úÖ –°–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞"
            else
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É"
            fi
        else
            echo "‚ùå –°–ª—É–∂–±–∞ not-your-mama-bot –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞"
        fi
    fi
    
    echo ""
    echo "üí° –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
    echo "‚Ä¢ –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –ø–æ SSH –∫ —Å–µ—Ä–≤–µ—Ä—É"
    echo "‚Ä¢ –í—ã–ø–æ–ª–Ω–∏—Ç–µ: cd /opt/not-your-mama-bot && git pull"
    echo "‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª—É–∂–±—É: sudo systemctl restart not-your-mama-bot"
    
    exit 0
fi

# –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å, –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–±—ã—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
echo "‚úÖ –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏"
echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±—ã—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
if [ -f "scripts/update.sh" ]; then
    bash scripts/update.sh
else
    echo "‚ùå –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi
