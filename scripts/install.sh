#!/bin/bash

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Not Your Mama Bot –¥–ª—è Ubuntu/Linux
set -e

echo "ü§ñ Not Your Mama Bot - –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è Ubuntu/Linux"
echo "================================================="
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ü–≤–µ—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ Ubuntu/Linux
check_os() {
    if [[ "$OSTYPE" != "linux-gnu"* ]]; then
        print_error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è Ubuntu/Linux"
        exit 1
    fi
    
    if [ ! -f /etc/debian_version ] && [ ! -f /etc/redhat-release ]; then
        print_warning "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Ubuntu/Debian. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–∏—Ö –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞—Ö."
    fi
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–∏—Å—Ç–µ–º—ã
install_system_deps() {
    print_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
    if command -v apt-get &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip python3-venv git curl
    elif command -v yum &> /dev/null; then
        sudo yum install -y python3 python3-pip git curl
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y python3 python3-pip git curl
    else
        print_error "–ù–µ –Ω–∞–π–¥–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä (apt, yum, dnf)"
        exit 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Python
check_python() {
    if ! command -v python3 &> /dev/null; then
        print_error "Python 3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
        install_system_deps
    fi
    
    PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
    print_success "Python $PYTHON_VERSION –Ω–∞–π–¥–µ–Ω"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ pip
check_pip() {
    if ! command -v pip3 &> /dev/null; then
        print_error "pip3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
        install_system_deps
    fi
    print_success "pip3 –Ω–∞–π–¥–µ–Ω"
}

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
get_bot_config() {
    echo ""
    print_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞"
    echo "=============="
    
    # Telegram Bot Token
    echo ""
    print_info "üì± –ü–æ–ª—É—á–µ–Ω–∏–µ Telegram Bot Token:"
    echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ @BotFather"
    echo "2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /newbot"
    echo "3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞"
    echo "4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (—Ñ–æ—Ä–º–∞—Ç: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz)"
    echo ""
    
    while true; do
        read -p "–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞: " TELEGRAM_BOT_TOKEN
        if [[ $TELEGRAM_BOT_TOKEN =~ ^[0-9]+:[A-Za-z0-9_-]+$ ]]; then
            break
        else
            print_error "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞. –ü—Ä–∏–º–µ—Ä: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz"
        fi
    done
    
    # Bot Username
    echo ""
    print_info "ü§ñ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –±–æ—Ç–∞:"
    echo "1. –í —Ç–æ–º –∂–µ —á–∞—Ç–µ —Å @BotFather –Ω–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞"
    echo "2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ—Ç–∞ (–º–æ–∂–Ω–æ —Å —Å–∏–º–≤–æ–ª–æ–º @)"
    echo "3. –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ –±–æ—Ç @my_awesome_bot, –≤–≤–µ–¥–∏—Ç–µ: @my_awesome_bot –∏–ª–∏ my_awesome_bot"
    echo ""
    
    while true; do
        read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –±–æ—Ç–∞: " BOT_USERNAME
        # –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª @ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        BOT_USERNAME=${BOT_USERNAME#@}
        
        if [[ $BOT_USERNAME =~ ^[a-zA-Z0-9_]+$ ]]; then
            break
        else
            print_error "–ò–º—è –±–æ—Ç–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è"
        fi
    done
    
    # OpenAI API Key
    echo ""
    print_info "üîë –ü–æ–ª—É—á–µ–Ω–∏–µ OpenAI API Key:"
    echo "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://platform.openai.com/api-keys"
    echo "2. –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π"
    echo "3. –ù–∞–∂–º–∏—Ç–µ 'Create new secret key'"
    echo "4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–ª—é—á (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'sk-' –∏–ª–∏ 'sk-proj-')"
    echo "5. ‚ö†Ô∏è  –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ - –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω"
    echo ""
    
    while true; do
        read -p "–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á OpenAI API: " OPENAI_API_KEY
        if [[ $OPENAI_API_KEY =~ ^sk-[A-Za-z0-9_-]+$ ]]; then
            break
        else
            print_error "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ OpenAI. –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'sk-' –∏–ª–∏ 'sk-proj-'"
        fi
    done
    
    # –¢–∏–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    echo ""
    print_info "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
    echo "1) –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (—Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞)"
    echo "2) –°–∏—Å—Ç–µ–º–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (systemd —Å–µ—Ä–≤–∏—Å)"
    echo "3) Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
    
    while true; do
        read -p "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç (1-3): " INSTALL_TYPE
        case $INSTALL_TYPE in
            1) INSTALL_TYPE="local"; break ;;
            2) INSTALL_TYPE="systemd"; break ;;
            3) INSTALL_TYPE="docker"; break ;;
            *) print_error "–í—ã–±–µ—Ä–∏—Ç–µ 1, 2 –∏–ª–∏ 3" ;;
        esac
    done
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    echo ""
    print_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
    echo "=========================="
    echo "–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞:"
    echo "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π: python bot.py"
    echo "2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É /start –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"
    echo "3. –í–∞—à ID –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å–∞–Ω –∫–∞–∫ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
    echo "4. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –±–æ—Ç–æ–º —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã /admin, /style, /update"
    echo ""
}

# –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
install_local() {
    print_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
    
    # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    if [ ! -d "venv" ]; then
        python3 -m venv venv
        print_success "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"
    fi
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    source venv/bin/activate
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    print_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    pip install --upgrade pip
    pip install -r requirements.txt
    
    # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
    cat > .env << EOF
TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN
OPENAI_API_KEY=$OPENAI_API_KEY
BOT_USERNAME=$BOT_USERNAME
EOF
    
    print_success "–õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    echo ""
    echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:"
    echo "  source venv/bin/activate"
    echo "  python bot.py"
}

# –°–∏—Å—Ç–µ–º–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
install_systemd() {
    print_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ root
    if [ "$EUID" -ne 0 ]; then
        print_error "–î–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ root"
        echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: sudo ./install.sh"
        exit 1
    fi
    
    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if ! id "botuser" &>/dev/null; then
        useradd -r -s /bin/false -d /opt/not-your-mama-bot botuser
        print_success "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å botuser —Å–æ–∑–¥–∞–Ω"
    fi
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    mkdir -p /opt/not-your-mama-bot
    mkdir -p /opt/not-your-mama-bot/logs
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
    cp -r . /opt/not-your-mama-bot/
    chown -R botuser:botuser /opt/not-your-mama-bot
    
    # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    cd /opt/not-your-mama-bot
    python3 -m venv venv
    source venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements.txt
    
    # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
    cat > .env << EOF
TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN
OPENAI_API_KEY=$OPENAI_API_KEY
BOT_USERNAME=$BOT_USERNAME
EOF
    
    chown botuser:botuser .env
    chmod 600 .env
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å
    cp scripts/not-your-mama-bot.service /etc/systemd/system/
    systemctl daemon-reload
    systemctl enable not-your-mama-bot
    systemctl start not-your-mama-bot
    
    print_success "–°–∏—Å—Ç–µ–º–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    echo ""
    echo "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º:"
    echo "  sudo systemctl status not-your-mama-bot"
    echo "  sudo systemctl restart not-your-mama-bot"
    echo "  sudo journalctl -u not-your-mama-bot -f"
}

# Docker —É—Å—Ç–∞–Ω–æ–≤–∫–∞
install_docker() {
    print_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker
    if ! command -v docker &> /dev/null; then
        print_error "Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
        exit 1
    fi
    
    # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
    cat > .env << EOF
TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN
OPENAI_API_KEY=$OPENAI_API_KEY
BOT_USERNAME=$BOT_USERNAME
EOF
    
    # –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    docker-compose up -d --build
    
    print_success "Docker —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    echo ""
    echo "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º:"
    echo "  docker-compose up -d    # –ó–∞–ø—É—Å–∫"
    echo "  docker-compose down     # –û—Å—Ç–∞–Ω–æ–≤–∫–∞"
    echo "  docker-compose logs -f  # –õ–æ–≥–∏"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    check_os
    check_python
    check_pip
    get_bot_config
    
    case $INSTALL_TYPE in
        "local")
            install_local
            ;;
        "systemd")
            install_systemd
            ;;
        "docker")
            install_docker
            ;;
    esac
    
    echo ""
    print_success "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    print_info "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    echo "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: python bot.py"
    echo "2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö (—Å—Ç–∞–Ω–µ—Ç —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º)"
    echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å—Ç–∏–ª—å –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /style"
    echo "4. –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∫–æ–º–∞–Ω–¥–æ–π /admin add <ID>"
    echo ""
    print_info "–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ./scripts/test-bot.sh"
    print_info "–î–ª—è –æ—Ç–ª–∞–¥–∫–∏: ./scripts/debug.sh"
}

# –ó–∞–ø—É—Å–∫
main
